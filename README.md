캡스톤설계

*********앞으로 수정본 발생시 - 여기다 어떻게 어느 부분을 어떤 것을 수정했는지 수정사항 및 진행상황을 공유해주세요************


11/24(영민) - 동선최적화 과정 추가(직선거리 기준 가장 가까운 곳으로 일정 추천되도록 하는 방법) 및 day별 동선을 볼 수 있는 선택창 기능 추가 => 데이터 처리 시간 증가로 인한 해결책 필요

11/25(영민) - 아래 내용
    
    1.
    Step 1 (우선순위): generate_plans 내부의 get_real_duration API 호출을 제거하고 haversine으로 대체 -> 시간 감소
    
    Step 2: hotel 카테고리를 추가
    
    Step 3: 네이버/구글 예약 딥링크 버튼 -> 예약 페이지가기 or 상세 페이지 이동 가능
    
    2.    
    후보군 추천될 시 중복된 내용 제거
    데이터 정제 (Deduplication): places = get_db_places(city) 직후에 이름이 같거나 비슷한 장소를 하나만 남기고 삭제하는 코드를 넣었습니다. (이미지가 있거나 평점이 높은 데이터를 우선적으로 남김)
    
    후보군 제거 (remove): 일정에 selected된 장소는 pool 리스트에서 즉시 제거(remove)되므로, 1일차에 간 곳이 2일차에 다시 나오지 않습니다.

    3.
    처리부, 출력부 분리
    처리부 -> travel_logic.py
    출력부 -> 2_여행일정출력부.py

| 단계 | 기능 블록 / 위치 | 상세 동작 |
| :---: | :--- | :--- |
| **START** | **사용자 / 클라이언트** (`2_일정추천출력부.py`) | 사용자가 최종 선택한 일정 ID, 사용자 정보(이름, 연락처), **결제 정보**를 포함한 `ReservationRequest`를 POST 요청 (`/api/v1/reservation`)으로 전송합니다. |
| **Step 1** | **요청 검증 & 재고 확인** (`/api/v1/reservation`) | 1. **Data Validation:** 요청 모델 필수 값 및 형식 검증. <br>2. **Availability Check:** 예약하려는 항공편, 숙소의 **실시간 재고(잔여 좌석/객실)**를 외부 API를 통해 재확인 (레이스 컨디션 방지). <br>3. **Price Check:** 서버에 저장된 가격과 **실시간 최종 가격**을 비교하여 변동 여부 확인. |
| **Step 2** | **트랜잭션 시작 & 병렬 요청** (`create_reservation`) | CPU/I/O 집약적인 외부 API 호출을 위해 `asyncio.to_thread` 또는 `concurrent.futures`를 활용하여 다음과 같은 작업을 **병렬**로 수행합니다. <br>1. **항공 예약:** 항공사 API에 예약 및 결제 요청. <br>2. **숙소 예약:** 숙소 예약 플랫폼 API에 예약 및 결제 요청. <br>3. **액티비티 예약:** 현지 액티비티 플랫폼에 예약 요청. |
| **Step 3** | **부분 실패 & 롤백 (Rollback)** | **트랜잭션 관리 핵심:** <br>a. **전체 성공 시:** Step 4로 이동. <br>b. **부분 실패 시** (예: 항공 예약만 실패): 이미 예약된 숙소/액티비티에 대해 **자동 취소(Cancellation/Rollback)** API를 호출하여 고객의 피해를 최소화하고 일관성을 유지합니다. |
| **Step 4** | **예약 최종 확정 및 DB 저장** (`/api/v1/reservation`) | 1. 모든 예약 건에 대해 파트너사 **예약 번호**를 수신. <br>2. 예약 상태를 **'Confirmed'**로 업데이트하고, 모든 상세 정보(예약 번호, 최종 결제 금액)를 내부 DB에 저장. |
| **Step 5** | **알림 및 응답** (`/api/v1/reservation`) | 1. 클라이언트에게 **최종 예약 확정 메시지 및 예약 ID**를 응답으로 반환. <br>2. 사용자에게 **예약 확정 이메일** (E-Ticket, 바우처 포함) 및 알림톡/문자 메시지 발송. |
| **END** | **시스템/사용자** | 예약 프로세스 완료. |
